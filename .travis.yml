language: generic

matrix:
  include:
    - os: linux
      dist: trusty
      sudo: required
      # Disabled until Travis CI allows using a different cache ID for each OS.
      # cache:
      #   directories:
      #     - $HOME/.cache/pip
      # before_cache:
      #   - rm -rf $HOME/.cache/pip/log
    - os: osx
      cache:
        directories:
          - /Users/travis/Library/Caches/pip
      before_cache:
        - rm -rf /Users/travis/Library/Caches/pip/log

before_install:
  - |
    case "$TRAVIS_OS_NAME" in
    osx)
      brew update &&
      brew install python --framework &&
      brew link --overwrite python &&
      brew install wxpython &&
      true
      ;;
    linux)
      sudo apt-add-repository -y ppa:benoit.pierre/plover &&
      sudo apt-get update -qq &&
      sudo apt-get install -y cython libudev-dev libusb-1.0-0-dev python-dev python-wxgtk3.0 python-xlib &&
      true
      ;;
    esac &&
    ./setup.py write_requirements &&
    # Upgrade setuptools, we need at least 19.6 to prevent issues with Cython patched 'build_ext' command.
    pip --disable-pip-version-check --timeout=5 --retries=2 install --upgrade --user 'setuptools>=19.6' &&
    # Manually install Cython if not already to speedup hidapi build.
    pip --disable-pip-version-check --timeout=5 --retries=2 install --user Cython &&
    pip --disable-pip-version-check --timeout=5 --retries=2 install --upgrade --user -r requirements.txt -c requirements_constraints.txt &&
    # And now downgrade setuptools so py2app works correctly...
    pip --disable-pip-version-check --timeout=5 --retries=2 install --upgrade --user 'setuptools==19.2' &&
    pip --disable-pip-version-check list &&
    true

install: true

script:
  - git fetch --unshallow
  - ./setup.py patch_version
  - ./setup.py test

before_deploy:
  - |
    case "$TRAVIS_OS_NAME" in
    osx)
      make -C osx &&
      true
      ;;
    linux)
      ./setup.py bdist_egg &&
      ./setup.py bdist_wheel &&
      true
      ;;
    esac &&
    du -hs dist/*

deploy:
  provider: releases
  skip_cleanup: true
  api_key:
    secure: nbrs6RbYbTiCcaIdOdyuOVm7Xdtptfspfzs+zQ1jN+BfO0XMsQOU7igJNR1ctwnC65oOkSSJj7SbUorh+Vj3x8YmcZB6Gdfjolufk8lvKkTdysLYloeIEcz96E3HymEwBbDwvBue6Ry9ZIRYAGGegazfXrsVLHtW2va7d0HPdtJDb+Z17kAS4/nCy5ayWvcocvhkFTCYhd3amO9Gb8nXywXx4/svU+Eyck8ZL8TcRBWEY0H4clW5XXy6KnZdkyzj3MZ50kS9cLVExvo34FOk9sdcWQhQHDSPlvMxtYD4sq1IoD/SyMmFtqKEYPPKuNT8EvhhrD0Wp86UllwPhZP11HCwRH7Q8FCJsglarsX81jV5469cdqk3JC+ayKrKgE8O1p1hOivtT9T6iH+myKRoCVhhgWn8uUbUDB5nBhSxPd71SQT90saSjM4EDgyjAYXJK0O69w+mt7ZrAhlARU7bOd9eTYSeCtd/EMdJ78vLfinhbddwjgn7dR46t0Rn5Intw4wvnOq6QPnsnCLOT+bvtPH5bJ+mTanaDDwYpT8xcxa1P8laWxSzzrABD7GEV4X2mr81TGjwT0WuQRMIgBOom+yd22WCMokpwD1xwqfogaMGRp4fl4srFY0K+W94CIZknYXswbc69BoxPPfUNKh8xz88Aavnrju7FGpH/lBdx5U=
  draft: true
  file_glob: true
  file:
    - "dist/*.dmg"
    - "dist/*.egg"
    - "dist/*.whl"
  on:
    tags: true
